<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>审核页面 - 分享点管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .thumb-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 5px;
    }
  </style>
</head>

<body class="bg-light">

  <div class="container mt-5">
    <h2 class="mb-4">分享点审核</h2>

    <!-- 表格 -->
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col">名称</th>
          <th scope="col">纬度</th>
          <th scope="col">经度</th>
          <th scope="col">描述</th>
          <th scope="col">图片</th>
          <th scope="col">时间</th>
          <th scope="col">地图</th>
          <th scope="col">操作</th>
        </tr>
      </thead>
      <tbody id="pointsTable">
        <!-- 数据通过JS填充 -->
      </tbody>
    </table>
  </div>

  <!-- 删除确认 Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">确认删除</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>确定要删除这个分享点吗？此操作不可撤销。</p>
          <div class="mb-3">
            <label for="deletePassword" class="form-label">请输入管理员密码</label>
            <input type="password" id="deletePassword" class="form-control" placeholder="输入密码">
          </div>
          <div id="deleteError" class="text-danger small d-none">密码错误，请重试。</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-danger">删除</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const BASE_URL = "https://chinaonrails.org:4000";
    const tableBody = document.getElementById("pointsTable");
    let deleteId = null; // 待删除ID

    // 获取并渲染数据
    async function loadPoints() {
      tableBody.innerHTML = `<tr><td colspan="8" class="text-center">加载中...</td></tr>`;
      try {
        const res = await fetch(BASE_URL + "/api/points");
        const points = await res.json();

        if (!points.length) {
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">暂无数据</td></tr>`;
          return;
        }

        tableBody.innerHTML = "";
        points.forEach(point => {
          const tr = document.createElement("tr");

          // 渲染图片（最多显示5张，避免太长）
          let imagesHtml = "";
          if (point.images && point.images.length) {
            imagesHtml = point.images.slice(0, 5).map(img =>
              `<a href="${BASE_URL + img}" target="_blank">
                 <img src="${BASE_URL + img}" class="thumb-img" alt="preview">
               </a>`
            ).join("");
          } else {
            imagesHtml = `<span class="text-muted">无</span>`;
          }

          // OpenStreetMap 链接
          const mapUrl = `https://www.openstreetmap.org/?mlat=${point.lat}&mlon=${point.lon}#map=16/${point.lat}/${point.lon}`;

          tr.innerHTML = `
            <td>${point.name || ""}</td>
            <td>${point.lat?.toFixed(6) || ""}</td>
            <td>${point.lon?.toFixed(6) || ""}</td>
            <td>${point.desc || ""}</td>
            <td>${imagesHtml}</td>
            <td>${new Date(point.timestamp).toLocaleString()}</td>
            <td><a href="${mapUrl}" target="_blank" class="btn btn-sm btn-primary">查看地图</a></td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="confirmDelete('${point._id}')">删除</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">加载失败</td></tr>`;
        console.error(err);
      }
    }

    // 删除确认
    function confirmDelete(id) {
      deleteId = id;
      new bootstrap.Modal(document.getElementById("deleteModal")).show();
    }

    // 执行删除
    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
      if (!deleteId) return;
      const password = document.getElementById("deletePassword").value.trim();
      if (!password) {
        document.getElementById("deleteError").classList.remove("d-none");
        document.getElementById("deleteError").innerText = "请输入密码";
        return;
      }

      try {
        const res = await fetch(BASE_URL + `/api/points/${deleteId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        const result = await res.json();
        if (result.success) {
          loadPoints();
          bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
          document.getElementById("deletePassword").value = "";
          document.getElementById("deleteError").classList.add("d-none");
        } else {
          document.getElementById("deleteError").classList.remove("d-none");
          document.getElementById("deleteError").innerText = result.message || "删除失败";
        }
      } catch (err) {
        document.getElementById("deleteError").classList.remove("d-none");
        document.getElementById("deleteError").innerText = "请求失败，请稍后再试";
        console.error(err);
      }
    });

    // 初始加载
    loadPoints();
  </script>
</body>

</html>
